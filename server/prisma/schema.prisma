generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Users {
  id                      String          @id @default(uuid())
  fullName                String?
  email                   String          @unique
  phoneNumber             String?         @unique
  password                String?
  authProvider            AuthProvider    @default(local)
  providerId              String?
  role                    UserRole        @default(passenger)
  status                  UserStatus      @default(unverified)
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  emailVerified           Boolean         @default(false)
  verificationToken       String?         @unique
  tokenExpiresAt          DateTime?
  resetToken              String?         @unique
  resetTokenExpiresAt     DateTime?
  notificationPreferences Json?           @default("{\"email\":{\"booking\":true,\"payment\":true,\"reminder\":true,\"promotion\":true},\"sms\":{\"booking\":true,\"payment\":false,\"reminder\":true,\"promotion\":false}}")
  activityLogs            ActivityLog[]
  bookings                Bookings[]
  notifications           Notifications[]
  reviews                 Reviews[]
}

model Locations {
  id                String      @id @default(uuid())
  name              String
  address           String?
  city              String
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt
  latitude          Float?
  longitude         Float?
  routesDestination Routes[]    @relation("RoutesDestination")
  routesOrigin      Routes[]    @relation("RoutesOrigin")
  tripStops         TripStops[]
}

model Buses {
  id          String   @id @default(uuid())
  plate       String   @unique
  amenities   Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  busType     BusType  @default(standard)
  priceFactor Float    @default(1.0)
  seats       Seats[]
  trips       Trips[]
}

model Seats {
  id         String             @id @default(uuid())
  busId      String
  seatNumber String
  bookings   Bookings[]
  seatLocks  SeatSegmentLocks[]
  bus        Buses              @relation(fields: [busId], references: [id])

  @@unique([busId, seatNumber])
  @@index([busId])
}

model Trips {
  id         String             @id @default(uuid())
  busId      String
  tripName   String?
  startTime  DateTime
  endTime    DateTime
  status     TripStatus         @default(scheduled)
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  bookings   Bookings[]
  seatLocks  SeatSegmentLocks[]
  tripRoutes TripRouteMap[]
  segments   TripSegments[]
  tripStops  TripStops[]
  bus        Buses              @relation(fields: [busId], references: [id])

  @@index([busId, startTime])
  @@index([startTime])
  @@index([status])
}

model TripStops {
  id              String         @id @default(uuid())
  tripId          String
  locationId      String
  sequence        Int
  arrivalTime     DateTime?
  departureTime   DateTime?
  bookingsDropoff Bookings[]     @relation("DropoffStop")
  bookingsPickup  Bookings[]     @relation("PickupStop")
  segmentFrom     TripSegments[] @relation("SegmentFrom")
  segmentTo       TripSegments[] @relation("SegmentTo")
  location        Locations      @relation(fields: [locationId], references: [id])
  trip            Trips          @relation(fields: [tripId], references: [id])

  @@unique([tripId, sequence])
  @@index([tripId])
}

model TripSegments {
  id              String             @id @default(uuid())
  tripId          String
  fromStopId      String
  toStopId        String
  segmentIndex    Int
  durationMinutes Int?
  seatLocks       SeatSegmentLocks[]
  fromStop        TripStops          @relation("SegmentFrom", fields: [fromStopId], references: [id])
  toStop          TripStops          @relation("SegmentTo", fields: [toStopId], references: [id])
  trip            Trips              @relation(fields: [tripId], references: [id])

  @@unique([tripId, segmentIndex])
  @@index([tripId])
}

model Routes {
  id                    String         @id @default(uuid())
  originLocationId      String
  destinationLocationId String
  name                  String
  description           String?
  isActive              Boolean        @default(false)
  createdAt             DateTime       @default(now())
  updatedAt             DateTime       @updatedAt
  bookings              Bookings[]
  destination           Locations      @relation("RoutesDestination", fields: [destinationLocationId], references: [id])
  origin                Locations      @relation("RoutesOrigin", fields: [originLocationId], references: [id])
  tripRoutes            TripRouteMap[]
}

model TripRouteMap {
  tripId  String
  routeId String
  price   Decimal
  route   Routes  @relation(fields: [routeId], references: [id])
  trip    Trips   @relation(fields: [tripId], references: [id])

  @@id([tripId, routeId])
  @@index([routeId])
  @@index([tripId])
}

model Bookings {
  id            String             @id @default(uuid())
  userId        String?
  tripId        String
  routeId       String
  seatId        String
  pickupStopId  String
  dropoffStopId String
  customerInfo  Json
  price         Decimal
  status        BookingStatus
  ticketCode    String?            @unique
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  dropoffStop   TripStops          @relation("DropoffStop", fields: [dropoffStopId], references: [id])
  pickupStop    TripStops          @relation("PickupStop", fields: [pickupStopId], references: [id])
  route         Routes             @relation(fields: [routeId], references: [id])
  seat          Seats              @relation(fields: [seatId], references: [id])
  trip          Trips              @relation(fields: [tripId], references: [id])
  user          Users?             @relation(fields: [userId], references: [id])
  notifications Notifications[]
  payments      Payments[]
  reviews       Reviews[]
  seatLocks     SeatSegmentLocks[]

  @@index([userId])
  @@index([tripId])
  @@index([routeId])
  @@index([seatId])
  @@index([ticketCode])
}

model SeatSegmentLocks {
  tripId    String
  seatId    String
  segmentId String
  bookingId String
  booking   Bookings     @relation(fields: [bookingId], references: [id])
  seat      Seats        @relation(fields: [seatId], references: [id])
  segment   TripSegments @relation(fields: [segmentId], references: [id])
  trip      Trips        @relation(fields: [tripId], references: [id])

  @@id([tripId, seatId, segmentId])
  @@index([tripId])
  @@index([seatId])
}

model Payments {
  id                   String        @id @default(uuid())
  bookingId            String
  amount               Decimal
  gateway              GatewayType?
  gatewayTransactionId String?
  status               PaymentStatus
  metadata             Json?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  orderCode            BigInt?       @unique
  booking              Bookings      @relation(fields: [bookingId], references: [id])
  refundedAmount       Decimal?      
  refundedAt           DateTime?    
  refundReason         String?

  @@index([bookingId])
  @@index([orderCode])
}

model Reviews {
  id        String   @id @default(uuid())
  bookingId String
  userId    String
  rating    Int
  comment   String?
  createdAt DateTime @default(now())
  booking   Bookings @relation(fields: [bookingId], references: [id])
  user      Users    @relation(fields: [userId], references: [id])
}

model Notifications {
  id        String             @id @default(uuid())
  userId    String
  bookingId String?
  type      NotificationType
  template  String?
  content   String?
  status    NotificationStatus @default(pending)
  sentAt    DateTime?
  createdAt DateTime           @default(now())
  booking   Bookings?          @relation(fields: [bookingId], references: [id])
  user      Users              @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([bookingId])
}

model SystemSettings {
  key         SettingKey @id
  value       Json
  description String?
  updatedAt   DateTime   @updatedAt
  createdAt   DateTime   @default(now())
}

model ActivityLog {
  id         String   @id @default(uuid())
  userId     String?
  action     String
  entityId   String?
  entityType String?
  metadata   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())
  user       Users?   @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([entityId, entityType])
  @@index([createdAt])
}

enum SettingKey {
  GENERAL
  BOOKING_RULES
  BUS_AMENITIES
  PAYMENT_GATEWAYS
  BUS_TYPE_PRICING
  PRICING_POLICIES
}

enum UserRole {
  passenger
  admin
}

enum UserStatus {
  active
  banned
  unverified
}

enum AuthProvider {
  local
  google
  firebase
}

enum TripStatus {
  scheduled
  ongoing
  completed
  cancelled
}

enum BookingStatus {
  pendingPayment
  confirmed
  cancelled
}

enum PaymentStatus {
  pending
  successful
  failed
  refunded
}

enum NotificationType {
  email
  sms
}

enum NotificationStatus {
  pending
  sent
  failed
}

enum GatewayType {
  momo
  zalopay
  payos
  paypal_sandbox
}

enum BusType {
  standard
  vip
  sleeper
  limousine
}
